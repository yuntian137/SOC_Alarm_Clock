/**
 *****************************************************************************************************
  * @copyright	(c)  Shenzhen Saiyuan Microelectronics Co., Ltd
  * @file	         main.c
  * @author	 
  * @version 	
  * @date	
  * @brief	         
  * @details         Contains the MCU initialization function and its H file
 *****************************************************************************************************
 * @attention
 *
 *****************************************************************************************************
 */
/*******************Includes************************************************************************/

#include "SC_Init.h"
#include "SC_it.h"
#include "..\Drivers\SCDriver_list.h"
#include "HeadFiles\SysFunVarDefine.h"
#include "Buzzer.h"
#include "Delay.h"
#include "TKDriver.h"
#include "sc32f10xx_TK_ParameterAnalysis.h"
/**************************************Generated by EasyCodeCube*************************************/
//Forbid editing areas between the labels !!!

/*************************************.Generated by EasyCodeCube.************************************/
uint8_t exKeyValue = 0;
uint8_t gTkIsValid = 0;
uint8_t Task_state = 0;
uint32_t TK_exKeyValueFlag;
void DataProcessing(uint32_t value)
{
    switch (TK_exKeyValueFlag)
    {
        case 0x00040000:
        exKeyValue = 18;// æ¨¡å¼/ç¡®è®¤
        break;
        case 0x00020000:
        exKeyValue = 17;// è¿”å›
        break;
        default:
        exKeyValue = 0xff;
        break;
    }
}
uint8_t first_Press;
void UpdateDisplay(uint8_t KeyValue)
{
    if (exKeyValue != 0XFF) // æ¾æ‰‹å‰åªå‡ºä¸€æ¬¡é”®
    {
        gTkIsValid = 1;
        ///KeyValue = exKeyValue;
        if (first_Press == 0)
        {
            if (KeyValue == 17)
            {
                GPIO_TogglePins(GPIOC, GPIO_Pin_4);  // LED ç¯ç¿»ï¿?
                GPIO_TogglePins(GPIOC, GPIO_Pin_10); // LED ç¯ç¿»ï¿?
            }
            else if (KeyValue == 18)
            {
                GPIO_TogglePins(GPIOC, GPIO_Pin_5);  // LED ç¯ç¿»ï¿?
                GPIO_TogglePins(GPIOC, GPIO_Pin_11); // LED ç¯ç¿»ï¿?
            }
            //è¾“å‡ºè§¦æ‘¸æŒ‰é”®æŒ‰ä¸‹çš„ï¿½?
            Delay_ms(100);
            printf("æŒ‰ä¸‹value%u\r\n", exKeyValue);
            first_Press = 1;
        }
    }
    else
    {
        gTkIsValid = 0;
        first_Press = 0;
    }
}
/**
 * @brief This function implements main function.
 * @note
 * @param
 */
uint32_t cnt1;
uint32_t cnt2;
int main(void)
{
    /*<Generated by EasyCodeCube begin>*/
/*<UserCodeStart>*//*<SinOne-Tag><36>*/
    IcResourceInit();
    TIM_Cmd(TIM2, DISABLE);
    Buzzer_SetVolume(50);
    TK_Init();                    //é‡è¦æ­¥éª¤1ï¼šTKçš„åˆå§‹åŒ–å‡½æ•°
    //<SinOne-Flag><36>/*<UserCodeEnd>*//*<SinOne-Tag><36>*/
    
/*<UserCodeStart>*/ /*<SinOne-Tag><4>*/
    /*****MainLoop*****/
    while (1)
    {
        /*****MainLoop*****/
        while(1)
        {
            /*<UserCodeStart>*//*<SinOne-Tag><4>*/
/*****MainLoop*****/
while(1)
{
    /*<UserCodeStart>*//*<SinOne-Tag><14>*/
            /***User program***/
            
            switch(Task_state)
            {
                case 0:                                 // init
                GPIO_ResetBits(GPIOC, GPIO_Pin_4);  // LED1
                GPIO_ResetBits(GPIOC, GPIO_Pin_10); // LED3
                GPIO_ResetBits(GPIOC, GPIO_Pin_11); // LED4
                GPIO_ResetBits(GPIOA, GPIO_Pin_7);  // LED5
                GPIO_ResetBits(GPIOA, GPIO_Pin_8);  // LED6
                Task_state = 1;
                break;
                case 1:                             // TK task
                WDT->WDT_CON |= WDT_CON_CLRWDT; // æ¸…watchdog
                
                // é‡è¦æ­¥éª¤2ï¼šè§¦æ‘¸é”®æ‰«æä¸€è½®æ ‡å¿—ï¼Œæ˜¯å¦è°ƒç”¨TouchKeyScan()ä¸€å®šè¦æ ¹æ®æ­¤æ ‡å¿—ä½ç½®èµ·ï¿?
                if (TK_TouchKeyStatus & 0x80)
                { // é‡è¦æ­¥éª¤3ï¼šæ¸…é™¤æ ‡å¿—ä½ï¼Œéœ€è¦å¤–éƒ¨æ¸…ï¿?
                    TK_TouchKeyStatus &= 0x7f;
                    // é‡è¦æ­¥éª¤4ï¼šåˆ†ææŒ‰é”®æ•°æ®ï¼Œå¹¶è¿”å›ç»“æœå‡ºï¿?
                    TK_exKeyValueFlag = TK_TouchKeyScan();
                    DataProcessing(TK_exKeyValueFlag); // æŒ‰é”®æ•°æ®å¤„ç†å‡½æ•°
                    
                    UpdateDisplay(exKeyValue);
                    TK_Restart(); // å¯åŠ¨ä¸‹ä¸€è½®è½¬ï¿?
                }
                if(cnt1 %300 == 0)
                {
                    cnt2++;
                    if(cnt2 % 80 == 0)
                    GPIO_TogglePins(GPIOA, GPIO_Pin_8); // LED ç¯ç¿»ï¿?
                }
                cnt1++;
                break;
                case 2: // Buzz SET
                break;
                case 3: // RGB SET
                break;
                case 4: // ADC get
                break;
            }
            
            //<SinOne-Flag><14>/*<UserCodeEnd>*//*<SinOne-Tag><14>*/
/*<UserCodeStart>*//*<SinOne-Tag><77>*/
            //<SinOne-Flag><77>/*<UserCodeEnd>*//*<SinOne-Tag><77>*/
/*<UserCodeStart>*//*<SinOne-Tag><453>*/
TIM_TI_DMA();
//<SinOne-Flag><453>/*<UserCodeEnd>*//*<SinOne-Tag><453>*/
/*<UserCodeStart>*//*<SinOne-Tag><469>*/
UART_Communication();
//<SinOne-Flag><469>/*<UserCodeEnd>*//*<SinOne-Tag><469>*/
/*<Begin-Inserted by EasyCodeCube for Condition>*/
    }
    //<SinOne-Flag><4>/*<UserCodeEnd>*//*<SinOne-Tag><4>*/
/*<Generated by EasyCodeCube end>*/
        }
    }
}
void Delay_us(uint16_t xus)
{
    TIM_Cmd(TIM1, ENABLE);
    while (TIM1->TIM_CNT < xus)
    ;
    TIM1->TIM_CNT = 0;
    TIM_Cmd(TIM1, DISABLE);
}

void Delay_ms(uint16_t xms)
{
    int i;
    for (i = 0; i < xms; i++)
    {
        Delay_us(1000);
    }
}

int fputc(int ch, FILE *f)
{
    //å‘é€å­—ç¬¦åˆ°UART0
    UART_SendData(UART2, (uint8_t)ch);
    while (!UART_GetFlagStatus(UART2, UART_Flag_TX))
    ;                                      // ç­‰å¾…å‘é€å®Œï¿?
    UART_ClearFlag(UART2, UART_Flag_TX); // æ¸…é™¤å‘é€å®Œæˆæ ‡ï¿?
    return ch;
}

